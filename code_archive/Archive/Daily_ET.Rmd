---
title: "R Notebook"
---

Beginning information from original Dobrowski et al 2013 appendix code:

 This script contains 4 functions used to model ET0 and water balance:
1. 'snowmod' estimates snowfall and snowpack and net moisture input as a function of temperature, precip, and existing snowpack.  It also outputs a vector of albedo values, generally 0.2 if there is no snow, or 0.8 if there is snow.
2. 'monthlyETO' for calculating monthly reference evapotranspiration
3. 'dailyET0' for calculating daily reference evapotranspiration
4. 'aetmod' estimates actual et [evapotranspiration], deficit, soil moisture and runoff as a function of moisture input, existing soil moisture, and soil water capacity.

 Author: Alan Swanson 2012

The third equation, daily ET0, is the one we are most interested in for the Ketapang climate data. The original code:
```{r}
dailyET0 <- function(radiation,tmax,tmin,wind,lat,elev,albedo=0.23,dpt,doy){
  # This is a ET0 function designed for daily inputs.  
  # Arguments:
  # radiation: vector of monthly average shortwave radiation in MJ/m^2/day
  # tmax, tmin: vectors of monthly average maximum and minimum temperatures in C, 
  # wind: vector of monthly average wind speed in m/s, 
  # tmean_prev: vector of mean temp for the previous month, 
  # lat: vector of latitude in degrees 
  # elev: vector of elevation in meters, 
  # albedo: scaler or vector of albedo values, 
  # doy: scalar day of year 1-365,
  # dpt: vector of dewpoint temperature in C.

  #
  # Value: 
  # Returns a vector of ET0 values.
	tmean <- (tmin+tmax)/2
	n_days <- 1 
	G <- 0 # assume soil heat flux to be zero
	
	# wind adjustment to 2m from 10m output
	hw=10 # height at which wind is measured
  wind <- wind*(4.87/log(67*hw-5.42))  
  
  # stomatal conductance adjustment for low temperatures
  sr=100 # stomatal resistance sec/m
	ks_min=.01 # minimum value for temps below T1
	Tl=-10       # minimum temp (sc goes to ks_min below this temp)
	T0=5		# optimal temp
	Th=100     # maximum temp (sc goes to zero above this)
	thresh=5   # temperature threshold below which to apply Jarvis equation (ks=1 above this temp)
	b4=(Th-T0)/(Th-Tl)  # from Jarvis 1978
	b3=1/((T0-Tl)*(Th-T0)^b4)
	ks=pmax(pmin(b3*(tmean-Tl)*(Th-tmean)^b4,1),ks_min)
	ks[is.na(ks)] <- ks_min
	ks[tmean>=thresh] <- 1
		
	# convert to stomatal resistance.
	sr <- sr/ks
		
	# ra is aerodynamic resistance, rs is bulk surface resistance
	ra <- 208/wind # 
	rs <- sr/(0.5*24*0.12) # value of 70 when sr=100
	
	# Saturation vapor pressure , 
	es <- 0.6108*exp(tmin*17.27/(tmin+237.3))/2+0.6108*exp(tmax*17.27/(tmax+237.3))/2  # saturation vapor pressure
	ea <- 0.6108*exp((dpt)*17.27/((dpt)+237.3))                                        # actual vapor pressure
	vpd <- es - ea
	vpd[vpd<0] <- 0    
  
	# delta - Slope of the saturation vapor pressure vs. air temperature curve
	delta <- (4098 * es)/(tmean + 237.3)^2  
	P <- 101.3*((293-0.0065*elev)/293)^5.26  # Barometric pressure in kPa
	lambda <- 2.501-2.361e-3*tmean # latent heat of vaporization    
	cp <- 1.013*10^-3 # specific heat of air
	gamma <- cp*P/(0.622*lambda) # Psychrometer constant (kPa C-1)
	pa <- P/(1.01*(tmean+273)*0.287) # mean air density at constant pressure
	
	# Calculate potential max solar radiation or clear sky radiation.
	GSC = 0.082      # MJ m -2 min-1 (solar constant)
	phi <- pi*lat/180 
	dr <- 1+0.033*cos(2*pi/365*doy)      
	delt <- 0.409*sin(2*pi/365*doy-1.39)     
	omegas <- acos(-tan(phi)*tan(delt))     
	Ra <- 24*60/pi*GSC*dr*(omegas*sin(phi)*sin(delt) +cos(phi)*cos(delt)*sin(omegas)) # daily extraterrestrial radiation
	Rso <- Ra*(0.75+2e-5*elev)     #For a cloudless day, Rs is roughly 75% of extraterrestrial radiation (Ra)

	# radfraction is a measure of relative shortwave radiation, or of
	# possible radiation (cloudy vs. clear-sky), needs to be less than 1
	radfraction <- radiation/Rso
	radfraction[radfraction>1] <- 1
	
	# longwave radiation
	longw <- 4.903e-9*n_days*((tmax+273.15)^4+(tmin+273.15)^4)/2*(.34-.14*sqrt(ea))*(1.35*radfraction-.35)     
	
  # net radiation
	netrad <- radiation*n_days*(1-albedo)-longw     
	
	# ET from long-form P-M eqn.
	et0 <- .408*((delta*(netrad-G))+(pa*cp*vpd/ra*3600*24*n_days))/(delta+gamma*(1+rs/ra))
	return(et0)
} 
```


We need to read in the climate data from Ketapang, and perform a couple of calculations to get everything into the right units and format. We already have maximum and minimum temperature in Celsisus, as well as humidity (assuming it is relative humidity). We also have wind speed but it needs to be converted from knots to meters per second, and the date needs to be converted to the day of the year (aka Julian date). Dewpoint can be calculated from temperature (minimum temperature), and radiation can be calcluated from teh hours of sunshine. We can use some simplifications to to calculate these more easily; need to check and see if these simplifications are valid. 
```{r}
# read in the Ketapang climate data
## no data is given the value 9999 in the original data; na.strings converts indicated values to NA (which is what R uses to indicate no data) without any extra steps
## 9999 is no data
## 8888 is no measurable data. not sure how this is different than no data... maybe these should actually be 0?
KTG<-read.csv("/Users/laurenhendricks/Documents/Borneo/Ketapang_ClimateFire/climate_data/KetapangClimate1986_2016 COPY.csv",header=T,sep=",",na.strings=c("9999","8888"))

# rename the columns into english
colnames(KTG)<-c("station","stationID","date","T_min","T_max","T_avg","humidity","precip","sunshine","wind_speed","wind_dir","wind_maxgust","wind_maxgust_dir")

# need to convert the dates of the data into date format
# note that because this data is from Indonesia, the day comes before the month
KTG$date<-as.Date(KTG$date, format= "%d/%m/%Y")
head(KTG$date)

# then need to convert the date into the day of the year for the function
KTG$doy<-as.numeric(strftime(KTG$date, format = "%j"))
head(KTG$doy)

# note that the wind speed is given in knots and it needs to be converted to m/s
# windspeed in meters per second = 0.5144444 * windspeed in knots
# also, we need to check the height that the wind speed was measured at!!!!!!
KTG$wind_speed_ms<-0.5144444*KTG$wind_speed

## note that sunshine is hours of sunshine, and needs to be converted to solar radiation! 
####### note potential problem in data --> there is one day with 13.5 hours of sunshine (18 Oct 2016) and another with 12.5 hours of sunshine (15 Jul 2016). Everything else is less than 12. Maybe these two days are errors? 
## monthly averaged clear sky insolation incident on a horizontal surface (kWh/m2/day) for airport location (-1.816, 109.963) from 22 year average is: (Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec)=(7.33,7.55,7.51,7.26,6.80,6.50,6.57,6.91,7.28,7.40,7.33,7.20)
#### 1 watt-hour = 3600 joules = .0036 Mjoules
## monthly averaged daylight hours for airport location (-1.816, 109.963) from 22 year average is: (Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec)=(12.2,12.1,12.1,12.0,12.0,12.0,12.0,12.0,12.1,12.1,12.2,12.2)
## both of these sets of values are from NASA Surface Meteorology and Solar Energy (https://eosweb.larc.nasa.gov/cgi-bin/sse/grid.cgi)

# use the clear sky insolation, hours of daylight, and sunshine hours to calcuate a rough radiation
# make a data frame with the month, insolation, and hours of daylight
month<-seq(1,12,1)
insolation<-c(7.33,7.55,7.51,7.26,6.80,6.50,6.57,6.91,7.28,7.40,7.33,7.20)
daylight<-c(12.2,12.1,12.1,12.0,12.0,12.0,12.0,12.0,12.1,12.1,12.2,12.2)

tmp<-cbind.data.frame(month,insolation,daylight)

# pull out just the month from the dates
KTG$month<-as.numeric(format(KTG$date,"%m"))
head(KTG$month)

# then use "join" from the plyr package to combine the two data sets based on the month value, and also preserve the original row order
library(plyr)
KTG<-join(KTG,tmp,by="month")

# last, calculate the radiation based on the percentage of total daylight hours sunshine was observed multiplied by the clear sky insolation, and then convert it to MJ
# 1KWh=3.6MJ
KTG$radiation<-((KTG$sunshine/KTG$daylight)*KTG$insolation)*3.6

# Ketapang airport is at approximately 1.8164Â°S --> -1.8164
# add this as a column to the data
KTG$lat<- -1.8164

# Ketapang airport elevation is approximately 14 meters (need to double check this)
# also add this as a column to the data
KTG$elev<-14

# calculate dewpoint using the simplification presented in Lawrence 2005 (may later want to use a more precise equation)
# this uses relative humidity (so assuming that the values in the spreadsheed are relative, not absolute!) and temperature
# dewpoint temperature = T - ((100 - relative humdiity)/5)
# T is the minimum temperature (check this)
KTG$dewpoint<-KTG$T_min-((100-KTG$humidity)/5)
head(KTG$dewpoint)
```

Then do the calculation for reference evapotranspiration:
```{r}
KTG$ET0_output<-dailyET0(radiation=KTG$radiation,tmax=KTG$T_max,tmin=KTG$T_min,wind=KTG$wind_speed_ms,lat=KTG$lat,elev=KTG$elev,dpt=KTG$dewpoint,doy=KTG$doy)
```

[[Here are some useful notes on evapotranspiration from the FAO: http://www.fao.org/docrep/x0490e/x0490e04.htm]]

And to calculate the soil water deficit, we need to use the fourth equation. We already have the reference evapotranspiration, calculated in the previous function. We also have the monthly water input, and it's already in the correct units (mm): precipiation. The function calls for soil water content from the previous month (day), but it will still function if it is left out.
This just leaves soil water capacity as the last thing that needs to be figured out (soil water capacity = difference between field capacity and permanent wilting point). 

Soil in the Ketapang area is, according to the FAO-UNESCO Soils Map: JD9 2/3a --> Dystric Fluvisols, medium/fine, level to undulating

"Use: Dystric Fluvisols occur mainly in Sumatra, Java, Kalimantan, Irian Jaya, Sulawesi and the Moluccas. They are developed on recent fluviatile, marine and lacustrine deposits and occupy positions on river levees, present flood plains, deltas and lake shores where alluvium is derived from predominantly acid parent rocks. Their macrorelief is generally flat, although levees often have an undulating microrelief. Soils subject to deep flooding remain under mixed swamp forest. Along coasts, soils which are periodically inundated by sea water are mainly under mangrove vegetation, which is intensively used in places for charcoal making. Where flooding is not too deep, or where flood protection and drainage works have been constructed, these soils are intensively used for paddy cultivation. Levee soils are traditionally used for settlement sites with home gardens, orchards and banana plantations. The better-drained Dystric Fluvisols of northern Sumatra produce Deliwrapper tobacco, and rubber and oil palm give very high yields.

Suitability. Most Dystric Fluvisols are stratified, medium to fine textured, and poorly to very poorly drained, although better-drained soils occur on levees. Soil reaction is slightly to strongly acid. Organic matter content is variable, but generally moderateto high. These soils are low in bases, but respond well to moderate applications of nitrogen and phosphate fertilizers. Water control presents the main problem for the successful utilization of these soils. A combination of irrigation during the dry season and flood protection and drainage during the rainy season is required on poorly drained soils. Where this is feasible, two crops of rice a year can be achieved, giving high yields under good management involving the use of high-yielding varieties, regular fertilizer application, and the use of insecticides and pesticides. In drier areas where irrigation water is limited, rainfed rice followed by a summer legume crop or tobacco gives satisfactory results under good management. Rubber, oil palm and sugar cane thrive where drainage is adequate. Where no drainage or flood control is required, these soils may be cultivated under a wide range of food, fruit and industrial crops with moderate applications of fertilizers. Where flood control is not feasible, recent developments in the breeding of floating rice varieties seem promising. The better-drained levee soils are generally fully utilized for settlement sites, home gardens, orchards and banana plantations." 
--FAO UNESCO Soil Map of the World

```{r}
aetmod <- function(et0,input,awc,soil_prev=NULL){
  # This function computes AET given ET0, H2O input, soil water capacity, and beginning-of-month soil moisture
  # Arguments:
  # et0: vector of monthly reference evapotranspiration in mm
  # input: vector of monthly water input to soil in mm
  # awc: vector of soil water capacity in mm
  # soil_prev: vector of soil water content for the previous month (mm).  If left NULL this is assigned to be zero.
  #
  # Value:
  # returns a data frame with columns for AET, deficit, end-of-month soil moisture, and runoff.
  
  N <- length(et0)
  runoff <- def <-  aet <- soil <- rep(NA,N) # 
  if(is.null(soil_prev)) soil_prev <- rep(0,N)
  
  deltasoil <- input-et0 # positive=excess H2O, negative=H2O deficit
  
  # Case when there is a moisture surplus:
    Case <- deltasoil>=0
  if(sum(Case)>0){
    aet[Case] <- et0[Case]
    def[Case] <- 0
    soil[Case] <- pmin(soil_prev[Case]+deltasoil[Case],awc[Case])	# increment soil moisture, but not above water holding capacity
    runoff[Case] <- pmax(soil_prev[Case]+deltasoil[Case]-awc[Case],0) # when awc is exceeded, send the rest to runoff
  }
  
  # Case where there is a moisture deficit:  soil moisture is reduced
  Case <- deltasoil<0
  if(sum(Case)>0){
    soildrawdown <- soil_prev[Case]*(1-exp(-(et0-input)[Case]/awc[Case]))	# this is the net change in soil moisture (neg)
    aet[Case] <- pmin(input[Case] + soildrawdown,et0[Case])
    def[Case] <- et0[Case] - aet[Case]
    soil[Case] <- soil_prev[Case]-soildrawdown
    runoff[Case] <- 0
  }
  
  return(data.frame(aet=aet,def=def,soil=soil,runoff=runoff))
  
}
```

Then do the calculation!!
```{r}
KTG$awc<-122 # just trying a random value --> it's the average value in http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.461.1371&rep=rep1&type=pdf
out<-aetmod(et0=KTG$ET0_output,input=KTG$precip,awc=KTG$awc,soil_prev=NULL)
```

