---
title: "Ketapang Climate Fire Extracting Relevant Fires"
output: pdf_document
---

Read in the necessary libraries, and make a mini-functino to read in the dates as actual dates. 

```{r}
# the libraries
library(sp)
library(GISTools)
library(rgdal)

# the mini function to read in dates in the format we want
setClass('yyyymmdd')
setAs("character","yyyymmdd", function(from) as.Date(from, format="%Y%m%d"))
```


Read in a very rough shapefile with the boundaries of the countries, and then extract the three countries that make up Borneo. (We don't need a detailed shapefile here, because it is just to give us a very general idea of where we are and to make sure that things are scaling correctly etc.)
```{r}
# read in the shapefile
countries<-readOGR(dsn="/Users/laurenhendricks/Documents/GIS_Data/ne_110m_admin_0_countries/",layer="ne_110m_admin_0_countries")

## NOTE: if we want better looking (i.e., more accurate) country boundaries, use this shapefile instead (and the rest of the code will still work fine)
#countries<-readOGR(dsn="/Users/laurenhendricks/Documents/GIS_Data/ne_10m_admin_0_map_units/",layer="ne_10m_admin_0_map_units")


# subset out Indonesia, Malaysia, and Brunei
SEAsia<-countries[countries$SOVEREIGNT=="Indonesia"|countries$SOVEREIGNT=="Malaysia"|countries$SOVEREIGNT=="Brunei",]

# plot it to make sure it works properly 
plot(SEAsia)

# reproject it UTM 49 S (CRS from http://spatialreference.org/ref/epsg/23889/)
SEAsia_proj<-spTransform(SEAsia,"+proj=utm +zone=49 +south +a=6378160 +b=6356774.50408554 +units=m +no_defs")

# plot it again to make sure things still look good
plot(SEAsia_proj)
```

Then make a shapefile with the Ketapang airport (KTG)
```{r}
# create a shapefile with the coordinates of KTG
KTG<-cbind(109.9619,-1.8166)
KTG.sp<-SpatialPoints(KTG,proj4string = CRS("+proj=longlat +ellps=WGS84"),bbox=NULL)
KTG.sp_proj<-spTransform(KTG.sp,"+proj=utm +zone=49 +south +a=6378160 +b=6356774.50408554 +units=m +no_defs")

# plot the airport on top of SE Asia
plot(SEAsia_proj)
plot(KTG.sp_proj,add=T,pch=17)
```

Now, make some buffers. Remember that gBuffer needs projected data! Also that the units of this projection are meters. 
```{r}
# buffers of varying distances. projection units are in meters! 
KTG_buffer5km<-gBuffer(KTG.sp_proj,width=5000,byid=FALSE)
KTG_buffer50km<-gBuffer(KTG.sp_proj,width=50000,byid=FALSE)
KTG_buffer250km<-gBuffer(KTG.sp_proj,width=250000,byid=FALSE)
KTG_buffer500km<-gBuffer(KTG.sp_proj,width=500000,byid=FALSE)

# then plot all of the buffers to make sure that it all works
plot(SEAsia_proj)
plot(KTG.sp_proj,add=T,pch=17)
plot(KTG_buffer500km,add=T,col="red")
plot(KTG_buffer250km,add=T,col="blue")
plot(KTG_buffer50km,add=T,col="green")
plot(KTG_buffer5km,add=T,col="yellow")
```

Transform all of the buffers back to lat/lon coordinates (unproject) so we can get the min and max coordinates of each, as a starting point for winnowing out the fire detections we want (basically, treat it as a square to start). 
```{r}
# transform (take away projection)
KTG_buffer5km_latlon<-spTransform(KTG_buffer5km,"+proj=longlat +ellps=WGS84")
KTG_buffer50km_latlon<-spTransform(KTG_buffer50km,"+proj=longlat +ellps=WGS84")
KTG_buffer250km_latlon<-spTransform(KTG_buffer250km,"+proj=longlat +ellps=WGS84")
KTG_buffer500km_latlon<-spTransform(KTG_buffer500km,"+proj=longlat +ellps=WGS84")

# then use bbox (in sp) to get the coordinates of the bounding box
#[1] is the min x coordinate; [2] is the min y coordinate; [3] is the max x coordinate; [4] is the max y coordinate
KTG_buffer5km_bbox<-bbox(KTG_buffer5km_latlon)
KTG_buffer50km_bbox<-bbox(KTG_buffer50km_latlon)
KTG_buffer250km_bbox<-bbox(KTG_buffer250km_latlon)
KTG_buffer500km_bbox<-bbox(KTG_buffer500km_latlon)
```


Start with the biggest buffer; everything else will be a subset of this file. This means that we'll only need to access all of the original fire detection files once. For now, model the distance around the airport as a square (and then later, plot them and cut out the ones that are not within a circular buffer). 
```{r}
# set the path where all of the fire detection files are located
path<-"/Volumes/Samsung USB/BORNEO/MODIS/mcd14ml/"

# make an empty variable to store the data in
detections_500km<-data.frame(YYYYMMD=integer(),HHMM=integer(),sat=logical(),lat=numeric(),lon=numeric(),T21=numeric(),T31=numeric(),
                 sample=integer(),FRP=numeric(),conf=integer(),type=integer())

# list of all of the file names
file.names <- dir(path, pattern =".txt")

# then the for loop to read through the files and subset out the desired fire detectiosn from every file, and append them to the list from the files that have already been opened
# remember for the bounding box: [1] is the min x coordinate; [2] is the min y coordinate; [3] is the max x coordinate; [4] is the max y coordinate
for(i in 1:length(file.names)){
  file <- read.table(paste(path,file.names[i],sep=""),header=TRUE, sep="")
  tmp<-subset(file,(file$lat>KTG_buffer500km_bbox[2] & file$lat<KTG_buffer500km_bbox[4]) & (file$lon>KTG_buffer500km_bbox[1] & file$lon<KTG_buffer500km_bbox[3]))    
  detections_500km<-rbind(detections_500km,tmp)
}


# turn the data frame into a spatial points data frame
detections_500km_sp<-SpatialPointsDataFrame(cbind(detections_500km$lon,detections_500km$lat),detections_500km,proj4string = CRS("+proj=longlat +ellps=WGS84"))
                                          
# project the data                                          
detections_500km_sp_proj<-spTransform(detections_500km_sp,"+proj=utm +zone=49 +south +a=6378160 +b=6356774.50408554 +units=m +no_defs")

# cut out only the things in the buffer
detections_500km_c<-detections_500km_sp_proj[KTG_buffer500km,]

# plot it to check and make sure it worked
plot(SEAsia_proj)
plot(detections_500km_c,add=T)

# then write out only the attribute table to a new file
write.table(detections_500km_c@data, file = "/Users/laurenhendricks/Documents/Borneo/Ketapang_ClimateFire/mcd14ml_KTG_500km.txt",sep=" ",row.names = FALSE)

# and print out the number of detections
print(paste(length(detections_500km$YYYYMMDD),"fire detections within a 1,000km by 1,000km box centered around KTG"))
print(paste(length(detections_500km_c$YYYYMMDD),"fire detections within a 500km radius of KTG"))

# and remove the data from memory
rm(detections_500km)
rm(detections_500km_c)
rm(detections_500km_sp)
```

Now read it in to check it out. 
```{r}
#firedetections_500km<-read.table("/Volumes/Samsung USB/BORNEO/MODIS/mcd14ml_KTG_500km.txt",header=T,sep=" ")
```

Then, to go to smaller and smaller distances from the airport, we can just pull things out of the 500km file instead of having to loop through everything again. 
```{r}
# cut out only the things in the 250 km buffer
detections_250km_c<-detections_500km_sp_proj[KTG_buffer250km,]

# plot it to check and make sure it worked
plot(SEAsia_proj)
plot(detections_250km_c,add=T)

# then write out only the attribute table to a new file
write.table(detections_250km_c@data, file = "/Users/laurenhendricks/Documents/Borneo/Ketapang_ClimateFire/mcd14ml_KTG_250km.txt",sep=" ",row.names = FALSE)

print(paste(length(detections_250km_c$YYYYMMDD),"fire detections within a 250km radius of KTG"))
```

```{r}
# subset out things within 50 km of KTG
detections_50km_c<-detections_500km_sp_proj[KTG_buffer50km,]

# plot it to check and make sure it worked
plot(SEAsia_proj)
plot(detections_50km_c,add=T)

# then write out only the attribute table to a new file
write.table(detections_50km_c@data, file = "/Users/laurenhendricks/Documents/Borneo/Ketapang_ClimateFire/mcd14ml_KTG_50km.txt",sep=" ",row.names = FALSE)

print(paste(length(detections_50km_c$YYYYMMDD),"fire detections within a 50km radius of KTG"))
```

```{r}
# subset out things within 5 km of KTG
detections_5km_c<-detections_500km_sp_proj[KTG_buffer5km,]

# plot it to check and make sure it worked
plot(SEAsia_proj)
plot(detections_5km_c,add=T)

# then write out only the attribute table to a new file
write.table(detections_5km_c@data, file = "/Users/laurenhendricks/Documents/Borneo/Ketapang_ClimateFire/mcd14ml_KTG_5km.txt",sep=" ",row.names = FALSE)

print(paste(length(detections_5km_c$YYYYMMDD),"fire detections within a 5km radius of KTG"))
```

